pipeline {
    agent any

    environment {
        // --- CONFIGURATION ---
        DOCKER_REPO = 'dhiaayadi/spring-app' 
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials' // V√©rifiez que cet ID existe dans Jenkins

        // ‚ö†Ô∏è CHEMIN ABSOLU VERS VOTRE FICHIER KUBERNETES
        // Les doubles backslashes \\ sont obligatoires sur Windows
        KUBE_PATH = 'C:\\Users\\HP\\.kube\\config'
        
        K8S_NAMESPACE = 'devops'
        SONAR_INSTANCE_NAME = 'SonarQube Server'
    }

    stages {

        stage('Git Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code...'
                git branch: 'main', url: 'https://github.com/dhiaayadi/Student-Management.git'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'üîé Analyse SonarQube...'
                script {
                    try {
                        withSonarQubeEnv(SONAR_INSTANCE_NAME) {
                            bat "mvnw.cmd clean verify sonar:sonar -DskipTests -Dsonar.projectKey=student-management -Dsonar.host.url=http://localhost:9000 -Dsonar.login=%SONAR_AUTH_TOKEN%"
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Analyse SonarQube ignor√©e."
                    }
                }
            }
        }

        stage('Maven Build') {
            steps {
                echo 'üõ† Compilation...'
                bat 'mvnw.cmd clean package -DskipTests'
                archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: false
            }
        }

        stage('Docker Build & Push') {
            steps {
                echo "üê≥ Docker Build & Push..."
                script {
                    bat "docker build -t ${DOCKER_REPO}:${IMAGE_TAG} ."
                    bat "docker tag ${DOCKER_REPO}:${IMAGE_TAG} ${DOCKER_REPO}:latest"

                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        bat 'echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin'
                        bat "docker push ${DOCKER_REPO}:${IMAGE_TAG}"
                        bat "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        stage('Kubernetes Deploy') {
            steps {
                echo '‚ò∏Ô∏è D√©ploiement Kubernetes...'
                script {
                    // C'EST ICI QUE LA MAGIE OP√àRE : On force le fichier de config
                    // On utilise \"%KUBE_PATH%\" pour que Windows lise bien le chemin
                    
                    // 1. Cr√©ation du Namespace
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" get namespace ${K8S_NAMESPACE} || kubectl --kubeconfig \"%KUBE_PATH%\" create namespace ${K8S_NAMESPACE}"

                    // 2. MySQL
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/mysql-storage.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/mysql-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 3. Mise √† jour de l'image dans le YAML via Groovy
                    def configFile = 'k8s/spring-deployment.yaml'
                    if (fileExists(configFile)) {
                        def fileContent = readFile(configFile)
                        def newContent = fileContent.replaceAll('image: .*', "image: ${DOCKER_REPO}:${IMAGE_TAG}")
                        writeFile file: configFile, text: newContent
                        echo "‚úÖ YAML mis √† jour avec : ${DOCKER_REPO}:${IMAGE_TAG}"
                    }

                    // 4. D√©ploiement Spring App
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/spring-config.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/spring-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 5. Red√©marrage propre
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" rollout restart deployment/spring-app -n ${K8S_NAMESPACE}"
                    
                    // Pause de 5 secondes pour laisser le temps √† K8s de r√©agir
                    sleep 5
                    
                    // V√©rification du statut
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" rollout status deployment/spring-app -n ${K8S_NAMESPACE} --timeout=2m"
                }
            }
        }

        stage('Verify') {
            steps {
                echo 'üîç V√©rification...'
                bat "kubectl --kubeconfig \"%KUBE_PATH%\" get pods -n ${K8S_NAMESPACE}"
                bat "kubectl --kubeconfig \"%KUBE_PATH%\" get svc -n ${K8S_NAMESPACE}"
            }
        }
    }
    
    post {
        always { cleanWs() }
    }
}

pipeline {
    agent any

    environment {
        // --- 1. CONFIGURATION DOCKER ---
        DOCKER_REPO = 'dhiaayadi/spring-app' 
        // Tag dynamique bas√© sur le num√©ro de build Jenkins (ex: 1.0.42)
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        // ID des identifiants stock√©s dans Jenkins
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'

        // --- 2. CONFIGURATION KUBERNETES (CRITIQUE SUR WINDOWS) ---
        // Chemin absolu vers votre fichier config. Les doubles \\ sont obligatoires.
        KUBE_PATH = 'C:\\Users\\HP\\.kube\\config'
        K8S_NAMESPACE = 'devops'

        // --- 3. AUTRES ---
        SONAR_INSTANCE_NAME = 'SonarQube Server'
    }

    stages {

        /* ==================== √âTAPE 1 : R√âCUP√âRATION DU CODE ==================== */
        stage('Git Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                git branch: 'main', url: 'https://github.com/dhiaayadi/Student-Management.git'
            }
        }

        /* ==================== √âTAPE 2 : ANALYSE SONARQUBE ==================== */
        stage('SonarQube Analysis') {
            steps {
                echo 'üîé Analyse du code...'
                script {
                    try {
                        withSonarQubeEnv(SONAR_INSTANCE_NAME) {
                            // mvnw.cmd est le wrapper pour Windows
                            bat "mvnw.cmd clean verify sonar:sonar -DskipTests -Dsonar.projectKey=student-management -Dsonar.host.url=http://localhost:9000 -Dsonar.login=%SONAR_AUTH_TOKEN%"
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Attention : Le serveur SonarQube n'est pas joignable. On continue quand m√™me."
                    }
                }
            }
        }

        /* ==================== √âTAPE 3 : COMPILATION JAVA ==================== */
        stage('Maven Build') {
            steps {
                echo 'üõ† Compilation du projet Spring Boot...'
                // Cr√©ation du .jar sans lancer les tests (pour aller plus vite)
                bat 'mvnw.cmd clean package -DskipTests'
                
                // On garde le fichier .jar pr√©cieusement pour l'√©tape Docker
                archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: false
            }
        }

        /* ==================== √âTAPE 4 : DOCKER (BUILD & PUSH) ==================== */
        stage('Docker Build & Push') {
            steps {
                echo "üê≥ Cr√©ation et envoi de l'image ${DOCKER_REPO}:${IMAGE_TAG}..."
                script {
                    // 1. Construction de l'image
                    bat "docker build -t ${DOCKER_REPO}:${IMAGE_TAG} ."
                    
                    // 2. Cr√©ation du tag 'latest' (toujours utile)
                    bat "docker tag ${DOCKER_REPO}:${IMAGE_TAG} ${DOCKER_REPO}:latest"

                    // 3. Connexion et Push vers Docker Hub
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        // Login s√©curis√© (√©vite d'afficher le mot de passe dans les logs)
                        bat 'echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin'
                        
                        // Envoi des images
                        bat "docker push ${DOCKER_REPO}:${IMAGE_TAG}"
                        bat "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        /* ==================== √âTAPE 5 : D√âPLOIEMENT KUBERNETES ==================== */
        stage('Kubernetes Deploy') {
            steps {
                echo '‚ò∏Ô∏è D√©ploiement sur le cluster...'
                script {
                    // NOTE IMPORTANTE : On ajoute --kubeconfig "%KUBE_PATH%" √† chaque ligne
                    // pour forcer Windows √† lire le bon fichier de configuration.

                    // 1. Cr√©ation du Namespace s'il n'existe pas
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" get namespace ${K8S_NAMESPACE} || kubectl --kubeconfig \"%KUBE_PATH%\" create namespace ${K8S_NAMESPACE}"

                    // 2. D√©ploiement de la Base de Donn√©es (MySQL)
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/mysql-storage.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/mysql-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 3. MISE √Ä JOUR DYNAMIQUE DE L'IMAGE DANS LE YAML
                    // On remplace l'ancienne version par la nouvelle version ${IMAGE_TAG}
                    def configFile = 'k8s/spring-deployment.yaml'
                    if (fileExists(configFile)) {
                        def fileContent = readFile(configFile)
                        // Regex pour remplacer "image: n'importe-quoi" par "image: votre-repo:votre-tag"
                        def newContent = fileContent.replaceAll('image: .*', "image: ${DOCKER_REPO}:${IMAGE_TAG}")
                        writeFile file: configFile, text: newContent
                        echo "‚úÖ Fichier YAML mis √† jour avec l'image : ${DOCKER_REPO}:${IMAGE_TAG}"
                    } else {
                        error "‚ùå ERREUR : Le fichier ${configFile} est introuvable !"
                    }

                    // 4. D√©ploiement de l'Application Spring
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/spring-config.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" apply -f k8s/spring-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 5. Red√©marrage pour appliquer la mise √† jour
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" rollout restart deployment/spring-app -n ${K8S_NAMESPACE}"
                    
                    // 6. Pause de s√©curit√© (5s) et v√©rification
                    sleep 5
                    bat "kubectl --kubeconfig \"%KUBE_PATH%\" rollout status deployment/spring-app -n ${K8S_NAMESPACE} --timeout=2m"
                }
            }
        }

        /* ==================== √âTAPE 6 : V√âRIFICATION FINALE ==================== */
        stage('Verify Deployments') {
            steps {
                echo 'üîç √âtat final du cluster :'
                bat "kubectl --kubeconfig \"%KUBE_PATH%\" get pods -n ${K8S_NAMESPACE}"
                bat "kubectl --kubeconfig \"%KUBE_PATH%\" get svc -n ${K8S_NAMESPACE}"
            }
        }
    }

    /* ==================== NETTOYAGE ==================== */
    post {
        always {
            echo 'üßπ Nettoyage de l\'espace de travail...'
            cleanWs()
        }
        success {
            echo "üéâ SUCC√àS : Application d√©ploy√©e (Version : ${IMAGE_TAG}) !"
        }
        failure {
            echo "‚ùå √âCHEC : V√©rifiez les logs ci-dessus pour l'erreur."
        }
    }
}

pipeline {
    agent any 

    environment {
        // Nom complet de l'image Docker (Docker Hub)
        DOCKER_IMAGE = "dhiaayadi/dhiaayadii" 
        
        // Nom du Deployment Kubernetes cible
        K8S_DEPLOYMENT_NAME = "spring-deployment" 
        
        // Namespace Kubernetes
        NAMESPACE = "devops"
        
        // Credentials Docker Hub (à configurer dans Jenkins)
        DOCKER_CREDENTIALS_ID = "docker-hub-credentials" 
    }

    stages {
        // Étape 1 : Récupération du code
        stage('1. Checkout Code') {
            steps {
                echo "--> Récupération du code depuis Git"
                checkout scm
            }
        }

        // Étape 2 : Compilation et package Maven
        stage('2. Build & Package') {
            steps {
                echo "--> Compilation du projet Spring Boot"
                sh 'mvn clean package -DskipTests'
            }
        }

        // Étape 3 : Dockerisation et Push
        stage('3. Docker Build & Push') {
            steps {
                script {
                    def imageTag = "${env.DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                    
                    echo "Construction de l'image Docker : ${imageTag}"
                    sh "docker build -t ${imageTag} ."

                    withCredentials([usernamePassword(
                        credentialsId: env.DOCKER_CREDENTIALS_ID, 
                        passwordVariable: 'DOCKER_PASSWORD', 
                        usernameVariable: 'DOCKER_USERNAME')]) {
                        
                        echo "Connexion à Docker Hub..."
                        sh "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}"
                        sh "docker push ${imageTag}"
                    }
                }
            }
        }

        // Étape 4 : Déploiement sur Kubernetes
        stage('4. Deploy to Kubernetes') {
            steps {
                script {
                    def imageTag = "${env.DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                    echo "--> Déploiement K8s de la version ${env.BUILD_NUMBER}"

                    // Correctif WSL / Permissions
                    withEnv(["KUBECONFIG=/var/lib/jenkins/.kube/config"]) { 
                        
                        // Met à jour l'image du Deployment
                        sh """
                            kubectl set image deployment/${env.K8S_DEPLOYMENT_NAME} \
                            spring-container=${imageTag} -n ${env.NAMESPACE}
                        """

                        echo "Attente de la stabilisation des pods..."
                        sh "kubectl rollout status deployment/${env.K8S_DEPLOYMENT_NAME} -n ${env.NAMESPACE} --timeout=5m"
                    }

                    echo "Déploiement terminé ✅"
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline terminé avec le statut : ${currentBuild.result ?: 'SUCCESS'}"
        }
        success {
            echo "✅ CI/CD SUCCESS : L'application est en ligne sur Kubernetes !"
        }
        failure {
            echo "❌ CI/CD FAILURE : Vérifiez les logs. Étape échouée : ${currentBuild.stageName}"
        }
    }
}

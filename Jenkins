pipeline {
    agent any

    environment {
        /* ================= CONFIGURATION ================= */
        
        // 1. DOCKER
        DOCKER_REPO = 'dhiaayadi/spring-app' 
        // Tag dynamique bas√© sur le num√©ro de build (ex: 1.0.45)
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        // Identifiants Docker Hub configur√©s dans Jenkins
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'

        // 2. KUBERNETES (LA CL√â DU PROBL√àME)
        // Chemin absolu vers votre fichier config sur Windows
        // Les doubles backslashes \\ sont OBLIGATOIRES
        KUBE_PATH = 'C:\\Users\\HP\\.kube\\config'
        K8S_NAMESPACE = 'devops'

        // 3. SONARQUBE
        SONAR_INSTANCE_NAME = 'SonarQube Server'
    }

    stages {

        /* ---------------- √âTAPE 1 : R√âCUP√âRATION DU CODE ---------------- */
        stage('Git Checkout') {
            steps {
                echo 'üì• Pulling source code...'
                git branch: 'main', url: 'https://github.com/dhiaayadi/Student-Management.git'
            }
        }

        /* ---------------- √âTAPE 2 : ANALYSE SONARQUBE ---------------- */
        stage('SonarQube Analysis') {
            steps {
                echo 'üîé Running SonarQube Analysis...'
                script {
                    try {
                        withSonarQubeEnv(SONAR_INSTANCE_NAME) {
                            bat "mvnw.cmd clean verify sonar:sonar -DskipTests -Dsonar.projectKey=student-management -Dsonar.host.url=http://localhost:9000 -Dsonar.login=%SONAR_AUTH_TOKEN%"
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Attention: Le serveur SonarQube n'est pas joignable. Le pipeline continue."
                    }
                }
            }
        }

        /* ---------------- √âTAPE 3 : BUILD MAVEN ---------------- */
        stage('Maven Build') {
            steps {
                echo 'üõ† Building Spring Boot JAR...'
                bat 'mvnw.cmd clean package -DskipTests'
                // Sauvegarde du JAR pour l'√©tape Docker
                archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: false
            }
        }

        /* ---------------- √âTAPE 4 : BUILD & PUSH DOCKER ---------------- */
        stage('Docker Build & Push') {
            steps {
                echo "üê≥ Building Docker image ${DOCKER_REPO}:${IMAGE_TAG}..."
                script {
                    // Construction
                    bat "docker build -t ${DOCKER_REPO}:${IMAGE_TAG} ."
                    bat "docker tag ${DOCKER_REPO}:${IMAGE_TAG} ${DOCKER_REPO}:latest"

                    // Envoi vers Docker Hub
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        bat 'echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin'
                        bat "docker push ${DOCKER_REPO}:${IMAGE_TAG}"
                        bat "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        /* ---------------- √âTAPE 5 : D√âPLOIEMENT KUBERNETES ---------------- */
        stage('Kubernetes Deploy') {
            steps {
                echo '‚ò∏Ô∏è Deploying to Kubernetes...'
                script {
                    // CORRECTION MAJEURE : On force l'utilisation du fichier config via --kubeconfig="%KUBE_PATH%"
                    // Cela emp√™che kubectl de se connecter √† localhost:8080 (Jenkins) par erreur.

                    // 1. Cr√©ation du Namespace
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" get namespace ${K8S_NAMESPACE} || kubectl --kubeconfig=\"%KUBE_PATH%\" create namespace ${K8S_NAMESPACE}"

                    // 2. D√©ploiement MySQL
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" apply -f k8s/mysql-storage.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" apply -f k8s/mysql-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 3. Mise √† jour de l'image dans le fichier YAML (Script Groovy)
                    def configFile = 'k8s/spring-deployment.yaml'
                    if (fileExists(configFile)) {
                        def fileContent = readFile(configFile)
                        // Remplace l'ancienne image par la nouvelle version tagu√©e
                        def newContent = fileContent.replaceAll('image: .*', "image: ${DOCKER_REPO}:${IMAGE_TAG}")
                        writeFile file: configFile, text: newContent
                        echo "‚úÖ YAML mis √† jour avec : ${DOCKER_REPO}:${IMAGE_TAG}"
                    } else {
                        error "‚ùå Fichier ${configFile} introuvable !"
                    }

                    // 4. D√©ploiement Spring Boot
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" apply -f k8s/spring-config.yaml -n ${K8S_NAMESPACE}"
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" apply -f k8s/spring-deployment.yaml -n ${K8S_NAMESPACE}"

                    // 5. Red√©marrage pour prise en compte imm√©diate
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" rollout restart deployment/spring-app -n ${K8S_NAMESPACE}"
                    
                    // 6. Pause de s√©curit√© (5s) et v√©rification du statut
                    sleep 5
                    bat "kubectl --kubeconfig=\"%KUBE_PATH%\" rollout status deployment/spring-app -n ${K8S_NAMESPACE} --timeout=2m"
                }
            }
        }

        /* ---------------- √âTAPE 6 : V√âRIFICATION ---------------- */
        stage('Verify Deployments') {
            steps {
                echo 'üîç Checking Pods status...'
                bat "kubectl --kubeconfig=\"%KUBE_PATH%\" get pods -n ${K8S_NAMESPACE}"
                bat "kubectl --kubeconfig=\"%KUBE_PATH%\" get svc -n ${K8S_NAMESPACE}"
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo "üéâ SUCC√àS : Pipeline termin√© et application d√©ploy√©e !"
        }
        failure {
            echo "‚ùå √âCHEC : Regardez les logs ci-dessus."
        }
    }
}

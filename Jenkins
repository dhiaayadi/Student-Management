pipeline {
    agent any

    environment {
        // --- CONFIGURATION ---
        // Remplacez par votre pseudo DockerHub
        DOCKER_REPO = 'dhiaayadi/dhiaayadii'
        
        // Utilise le num√©ro de build Jenkins comme tag (ex: 1.0.45)
        IMAGE_TAG = "1.0.${BUILD_NUMBER}"
        
        K8S_NAMESPACE = 'devops'
        
        // ID des identifiants cr√©√©s dans Jenkins (Username/Password)
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        
        // Nom de votre installation SonarQube dans Jenkins (Manage Jenkins -> System)
        SONAR_INSTANCE_NAME = 'SonarQube Server'
    }

    stages {

        /* ---------------------------- 1. GIT CHECKOUT ---------------------------- */
        stage('Git Checkout') {
            steps {
                echo 'üì• Pulling source code...'
                // R√©cup√©ration du code (URL corrig√©e sans le .git.git) 
                git branch: 'main', url: 'https://github.com/dhiaayadi/Student-Management.git'
            }
        }

        /* -------------------------- 2. SONARQUBE ANALYSIS -------------------------- */
        stage('SonarQube Analysis') {
            steps {
                echo 'üîé Running SonarQube Analysis...'
                script {
                    // Utilisation de try/catch pour √©viter de bloquer si Sonar n'est pas joignable
                    try {
                        withSonarQubeEnv(SONAR_INSTANCE_NAME) {
                            // Utilisation de 'bat' pour Windows et 'mvnw.cmd'
                            bat '''
                                mvnw.cmd clean verify sonar:sonar -DskipTests ^
                                -Dsonar.projectKey=student-management ^
                                -Dsonar.host.url=http://localhost:9000 ^
                                -Dsonar.login=%SONAR_AUTH_TOKEN%
                            '''
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Attention: Analyse SonarQube √©chou√©e ou ignor√©e. V√©rifiez le nom du serveur dans Jenkins."
                    }
                }
            }
        }

        /* ------------------------------ 3. MAVEN BUILD ------------------------------ */
        stage('Maven Build') {
            steps {
                echo 'üõ† Building Spring Boot...'
                // Construction du .jar sans lancer les tests unitaires 
                bat 'mvnw.cmd clean package -DskipTests'
                
                // Sauvegarde l'artefact pour les √©tapes suivantes
                archiveArtifacts artifacts: 'target/*.jar'
            }
        }

        /* --------------------------- 4. DOCKER BUILD & PUSH --------------------------- */
        stage('Docker Build & Push') {
            steps {
                echo 'üê≥ Building Docker images...'

                script {
                    // Construction de l'image
                    bat "docker build -t %DOCKER_REPO%:%IMAGE_TAG% ."
                    // Tag 'latest' pour faciliter les pulls manuels
                    bat "docker tag %DOCKER_REPO%:%IMAGE_TAG% %DOCKER_REPO%:latest"

                    // Connexion s√©curis√©e et envoi vers DockerHub 
                    withCredentials([usernamePassword(
                        credentialsId: DOCKER_CREDENTIALS_ID,
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat '''
                            @echo off
                            echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
                        '''
                        bat "docker push %DOCKER_REPO%:%IMAGE_TAG%"
                        bat "docker push %DOCKER_REPO%:latest"
                    }
                }
            }
        }

        /* ------------------------------ 5. KUBERNETES DEPLOY ------------------------------ */
        stage('Kubernetes Deploy') {
            steps {
                echo '‚ò∏Ô∏è Deploying to Kubernetes cluster...'
                
                script {
                    // Cr√©ation du namespace s'il n'existe pas (syntaxe Windows avec || conditionnel)
                    bat "kubectl get namespace %K8S_NAMESPACE% || kubectl create namespace %K8S_NAMESPACE%"

                    // Application de la config MySQL [cite: 7]
                    bat "kubectl apply -f k8s/mysql-storage.yaml -n %K8S_NAMESPACE%"
                    bat "kubectl apply -f k8s/mysql-deployment.yaml -n %K8S_NAMESPACE%"

                    // --- Remplacement Dynamique de l'Image (Compatible Windows) ---
                    // On utilise Groovy pour lire et modifier le fichier YAML car 'sed' n'existe pas par d√©faut sur Windows
                    def configFile = 'k8s/spring-deployment.yaml'
                    if (fileExists(configFile)) {
                        def fileContent = readFile(configFile)
                        // Remplace n'importe quelle image par la nouvelle version tagu√©e
                        def newContent = fileContent.replaceAll('image: .*', "image: ${DOCKER_REPO}:${IMAGE_TAG}")
                        writeFile file: configFile, text: newContent
                        echo "‚úÖ Fichier YAML mis √† jour avec l'image: ${DOCKER_REPO}:${IMAGE_TAG}"
                    } else {
                        error "‚ùå Fichier ${configFile} introuvable !"
                    }

                    // D√©ploiement de l'application Spring [cite: 13]
                    bat "kubectl apply -f k8s/spring-config.yaml -n %K8S_NAMESPACE%"
                    bat "kubectl apply -f k8s/spring-deployment.yaml -n %K8S_NAMESPACE%"

                    // Force le red√©marrage pour prendre en compte la nouvelle image
                    // Note: 'spring-app' doit √™tre le nom du Deployment dans votre YAML
                    bat "kubectl rollout restart deployment/spring-app -n %K8S_NAMESPACE%"
                    
                    // Attente de la validation du d√©ploiement
                    bat "kubectl rollout status deployment/spring-app -n %K8S_NAMESPACE% --timeout=5m"
                }
            }
        }

        /* ------------------------------ 6. VERIFICATION ------------------------------ */
        stage('Verify Deployments') {
            steps {
                echo 'üîç Checking Kubernetes resources...'
                // Affichage final des pods pour v√©rification [cite: 15]
                bat "kubectl get pods -n %K8S_NAMESPACE%"
                bat "kubectl get svc -n %K8S_NAMESPACE%"
            }
        }
    }

    post {
        success {
            echo "üéâ Pipeline termin√© avec succ√®s !"
        }
        failure {
            echo "‚ùå Le Pipeline a √©chou√©. V√©rifiez les logs ci-dessus."
        }
        always {
            // Nettoyage de l'espace de travail pour √©conomiser de la place
            cleanWs()
        }
    }
}
